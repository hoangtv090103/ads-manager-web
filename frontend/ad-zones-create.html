<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo vùng quảng cáo - Ads Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./css/toast.css">
    <script src="./js/auth.js"></script>
<script src="./js/toast.js"></script>
    <script src="./js/script.js"></script>
    <style>
        .form-container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #4F4F4F;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            background-color: white;
        }

        .form-input::placeholder {
            color: #BDBDBD;
        }

        .ad-format-section {
            margin-top: 24px;
        }

        .format-title {
            font-size: 14px;
            font-weight: 500;
            color: #4F4F4F;
            margin-bottom: 16px;
        }

        .format-required {
            color: #EB5757;
            font-size: 12px;
            margin-left: 4px;
        }

        .format-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .format-group {
            margin-bottom: 16px;
        }

        .format-group-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .checkbox-group {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #0061C1;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .backup-ads {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .backup-ads-label {
            font-size: 14px;
            color: #4F4F4F;
        }

        .form-actions {
            margin-top: 32px;
            display: flex;
            gap: 16px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #0061C1;
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #4F4F4F;
            border: 1px solid #E0E0E0;
        }

        @media (max-width: 768px) {
            .format-grid {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 12px;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .format-group {
            margin-bottom: 24px;
        }

        .format-group-title {
            font-weight: 500;
            margin-bottom: 12px;
            color: #333;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: #F8F9FA;
        }

        .format-size {
            color: #828282;
            font-size: 12px;
            margin-left: 4px;
        }

        /* Styles cho backup ads section */
        #backupAdsOptions {
            margin-top: 16px;
            padding: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            background-color: #F8F9FA;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        #backupAdsToggle {
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <!-- Toggle Menu Button -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">

            <span class="logo-text">Ads Manager</span>
        </div>

        <nav class="sidebar-nav">
            <a href="/frontend/campaigns.html" class="nav-item">
                <i class="fas fa-layer-group"></i>
                <span>Quản lý chiến dịch</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-box"></i>
                    <span>Quản lý sản phẩm</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/product-groups.html">• Danh sách nhóm SP</a>
                    <a href="/frontend/products.html">• Danh sách SP</a>
                    <a href="/frontend/data-sources.html">• Nguồn cấp dữ liệu</a>
                </div>
            </div>

            <a href="/frontend/target-audience.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Quản lý đối tượng</span>
            </a>



            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/website-report.html">• Báo cáo website</a>
                    <a href="/frontend/zone-report.html">• Báo cáo vùng</a>
                    <a href="/frontend/publisher-report.html" class="active">• Báo cáo publisher</a>
                    <a href="/frontend/ad-format-report.html">• Báo cáo định dạng quảng cáo</a>
                </div>
            </div>

            <a href="/frontend/publishers.html" class="nav-item">
                <i class="fas fa-users-cog"></i>
                <span>Danh sách Publisher</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-globe"></i>
                    <span>Quản lý website</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/price-lists.html">• Danh sách bảng giá</a>
                    <a href="/frontend/websites.html">• Danh sách website</a>
                    <a href="/frontend/ad-zones.html">• Danh sách vùng QC</a>
                </div>
            </div>

            <a href="/frontend/accounts.html" class="nav-item">
                <i class="fas fa-user-shield"></i>
                <span>Quản lý phân quyền</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header-content"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #4F4F4F;">
                <i class="fas fa-globe"></i>
                <span style="font-size: 14px;">/ Quản lý website / Danh sách vùng quảng cáo / Thêm mới vùng quảng
                    cáo</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div>
                    <div style="font-weight: 500; color: #333; text-align: right;">Lê Bách</div>
                    <div style="font-size: 12px; color: #828282;">Admin</div>
                </div>
                <img src="../assets/avatar.jpg" alt="User Avatar"
                    style="width: 40px; height: 40px; border-radius: 4px;">
            </div>
        </div>

        <div class="form-container">
            <h1 style="margin: 0 0 24px 0; font-size: 20px; color: #333;">Tạo vùng quảng cáo</h1>

            <form id="adZoneForm">
                <div class="form-group">
                    <label class="form-label">Website domain</label>
                    <select id="websiteSelect" class="form-select" required>
                        <option value="">Chọn website domain</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Tên vùng</label>
                    <input type="text" id="zoneName" class="form-input" placeholder="Tên vùng quảng cáo" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Kích thước quảng cáo</label>
                    <select id="sizeSelect" class="form-select" required>
                        <option value="">Chọn kích thước</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Định dạng quảng cáo</label>
                    <div id="formatContainer" class="format-container"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="window.location.href='ad-zones.html'">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveAdZone()">Hoàn tất</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const baseUrl = 'http://127.0.0.1:5000/api/v1';

        document.addEventListener('DOMContentLoaded', function () {
            requireAuth();
            loadWebsites();
            loadAdSizes();
            setupBackupAdsToggle();

        });
        // Thêm event listener cho select kích thước
        const sizeSelect = document.getElementById('sizeSelect');
        sizeSelect.addEventListener('change', function () {
            const selectedSizeId = this.value;
            if (selectedSizeId) {
                loadAdFormatsBySize(selectedSizeId);
            } else {
                document.getElementById('formatContainer').innerHTML = '';
            }
        });

        async function loadWebsites() {
            try {
                const response = await fetchWithAuth(`${baseUrl}/websites`);
                if (!response.ok) throw new Error('Failed to fetch websites');

                const data = await response.json();
                const select = document.getElementById('websiteSelect');

                data.websites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website.website_id;
                    option.textContent = `${website.domain_website}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading websites:', error);
                Toast.error('Không thể tải danh sách website');
            }
        }

        async function loadAdSizes() {
            try {
                const response = await fetchWithAuth(`${baseUrl}/ads-zone-sizes`);
                if (!response.ok) throw new Error('Failed to fetch ad sizes');

                const data = await response.json();
                const sizes = data.sizes;
                const select = document.getElementById('sizeSelect');

                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.size_id;
                    option.textContent = size.ten_kich_thuoc;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading ad sizes:', error);
                Toast.error('Không thể tải danh sách kích thước quảng cáo');
            }
        }

        function setupBackupAdsToggle() {
            const toggle = document.getElementById('backupAdsToggle');
            const section = document.getElementById('backupAdsSection');

            toggle.addEventListener('change', function () {
                section.style.display = this.checked ? 'block' : 'none';
            });
        }

        async function saveAdZone() {
            try {
                const form = document.getElementById('adZoneForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const selectedFormats = Array.from(document.querySelectorAll('input[name="format"]:checked'))
                    .map(cb => cb.value);

                if (selectedFormats.length === 0) {
                    Toast.error('Vui lòng chọn ít nhất 1 định dạng');
                    return;
                }

                const zoneData = {
                    website_id: parseInt(document.getElementById('websiteSelect').value),
                    ten_vung_quang_cao: document.getElementById('zoneName').value,
                    size_id: parseInt(document.getElementById('sizeSelect').value),
                    formats: selectedFormats
                };

                const response = await fetchWithAuth(`${baseUrl}/ads-zones`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(zoneData)
                });

                if (!response.ok) {
                    throw new Error('Failed to create ad zone');
                }

                window.location.href = 'ad-zones.html';
            } catch (error) {
                console.error('Error saving ad zone:', error);
                Toast.error('Không thể lưu vùng quảng cáo. Vui lòng thử lại sau.');
            }
        }

        // Hàm load định dạng quảng cáo dựa theo kích thước
        async function loadAdFormatsBySize(sizeId) {
            try {
                const response = await fetchWithAuth(`${baseUrl}/ad-size-formats/${sizeId}`);
                if (!response.ok) throw new Error('Failed to fetch ad formats');

                const data = await response.json();
                const formats = data.formats;
                const formatContainer = document.getElementById('formatContainer');
                formatContainer.innerHTML = ''; // Clear existing formats

                // Group formats by campaign type
                const formatsByType = formats.reduce((acc, format) => {
                    if (!acc[format.ten_loai_chien_dich]) {
                        acc[format.ten_loai_chien_dich] = [];
                    }
                    acc[format.ten_loai_chien_dich].push(format);
                    return acc;
                }, {});

                // Create HTML for each campaign type and its formats
                Object.entries(formatsByType).forEach(([campaignType, formats]) => {
                    const typeSection = document.createElement('div');
                    typeSection.className = 'format-group';
                    typeSection.innerHTML = `
                        <div class="format-group-title">${campaignType}</div>
                        <div class="checkbox-group">
                            ${formats.map(format => `
                                <label class="checkbox-item">
                                    <input type="checkbox" 
                                           name="format" 
                                           value="${format.format_id}">
                                    ${format.format_name}
                                    <small class="format-size">${format.ten_kich_thuoc}</small>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    formatContainer.appendChild(typeSection);
                });

            } catch (error) {
                console.error('Error loading ad formats:', error);
                Toast.error('Không thể tải danh sách định dạng quảng cáo');
            }
        }

        // Thêm xử lý hiển thị/ẩn phần backup ads
        document.addEventListener('DOMContentLoaded', function() {
            const backupAdsToggle = document.getElementById('backupAdsToggle');
            const backupAdsOptions = document.getElementById('backupAdsOptions');

            backupAdsToggle.addEventListener('change', function() {
                backupAdsOptions.style.display = this.checked ? 'block' : 'none';
                
                // Reset các trường backup ads khi tắt
                if (!this.checked) {
                    document.getElementById('backupAdsType').value = '';
                    document.getElementById('backupAdsCode').value = '';
                }
            });
        });
    </script>
</body>

</html>