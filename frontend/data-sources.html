<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nguồn cấp dữ liệu - Ads Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
    <script src="./js/auth.js"></script>
<script src="./js/toast.js"></script>
    <style>
        .main-content {
            margin-left: 250px;
            padding: 24px 40px;
            background-color: #F8F9FA;
            min-height: 100vh;
        }

        .description {
            margin: 24px 0;
            color: #4F4F4F;
            font-size: 14px;
            line-height: 1.6;
            max-width: 900px;
        }

        .email-link {
            color: #0061C1;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .link {
            color: #0061C1;
            text-decoration: none;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            align-items: center;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            padding: 8px 12px;
            margin-left: 16px;
            width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            margin-left: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #0061C1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-secondary {
            background: white;
            color: #0061C1;
            border: 1px solid #0061C1;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .data-sources-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-sources-table th {
            background: #F8F9FA;
            color: #4F4F4F;
            font-weight: 500;
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
        }

        .data-sources-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #E0E0E0;
            color: #333333;
            font-size: 14px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .status-active {
            background: #E3F2FD;
            color: #2F80ED;
        }

        .status-inactive {
            background: #FFE5E5;
            color: #EB5757;
        }

        .table-footer {
            margin-top: 16px;
            color: #4F4F4F;
            font-size: 14px;
        }

        /* Checkbox style */
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <!-- Toggle Menu Button -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            
            <span class="logo-text">Ads Manager</span>
        </div>

        <nav class="sidebar-nav">
            <a href="/frontend/campaigns.html" class="nav-item">
                <i class="fas fa-layer-group"></i>
                <span>Quản lý chiến dịch</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-box"></i>
                    <span>Quản lý sản phẩm</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/product-groups.html">• Danh sách nhóm SP</a>
                    <a href="/frontend/products.html">• Danh sách SP</a>
                    <a href="/frontend/data-sources.html">• Nguồn cấp dữ liệu</a>
                </div>
            </div>

            <a href="/frontend/target-audience.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Quản lý đối tượng</span>
            </a>



            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/website-report.html">• Báo cáo website</a>
                    <a href="/frontend/zone-report.html">• Báo cáo vùng</a>
                    <a href="/frontend/publisher-report.html" class="active">• Báo cáo publisher</a>
                    <a href="/frontend/ad-format-report.html">• Báo cáo định dạng quảng cáo</a>
                </div>
            </div>

            <a href="/frontend/publishers.html" class="nav-item">
                <i class="fas fa-users-cog"></i>
                <span>Danh sách Publisher</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-globe"></i>
                    <span>Quản lý website</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/price-lists.html">• Danh sách bảng giá</a>
                    <a href="/frontend/websites.html">• Danh sách website</a>
                    <a href="/frontend/ad-zones.html">• Danh sách vùng QC</a>
                </div>
            </div>
            <a href="/frontend/accounts.html" class="nav-item">
                <i class="fas fa-user-shield"></i>
                <span>Quản lý phân quyền</span>
            </a>
        </nav>
    </div>

    <div class="main-content">
        <!-- Header -->
        <div class="header-content">
            <div class="breadcrumb">
                <i class="fas fa-box"></i>
                <span>/ Quản lý sản phẩm / Nguồn cấp dữ liệu</span>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="user-name"></div>
                    <div class="user-email" id="user-email"></div>
                </div>
                <i class="fas fa-user"></i>
                <div class="user-dropdown">
                    <div class="dropdown-item" onclick="auth.logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </div>
                </div>
            </div>
        </div>

        <h1 class="page-title">Nguồn cấp dữ liệu</h1>

        <div class="description">
            Bạn sẽ cập nhật dữ liệu sản phẩm của mình trên một tệp Google Trang tính và các cập nhật đó sẽ tự động áp
            dụng cho tài khoản của bạn.
            Tìm hiểu thêm phần mô tả trường dữ liệu sản phẩm <a href="#" class="link">tại đây</a>.
            Trong trường hợp bị hủy cấp quyền, bạn vui lòng cấp quyền truy cập vào Google Sheet nguồn dữ liệu cho email
            sau:
            <a href="mailto:novanet-google-sheets@novanet-dev.iam.gserviceaccount.com" class="email-link">
                novanet-google-sheets@novanet-dev.iam.gserviceaccount.com
                <i class="fas fa-copy"></i>
            </a>
        </div>

        <div class="table-container">
            <div class="action-bar">
                <div style="display: flex; gap: 16px;">
                    <button class="btn-primary" onclick="createDataSource()">
                        <i class="fas fa-plus"></i>
                        Tạo nguồn dữ liệu
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Tìm kiếm...">
                    </div>
                </div>
                <button class="btn-secondary" onclick="viewProducts()">
                    Xem sản phẩm
                </button>
            </div>

            <table class="data-sources-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox"></th>
                        <th>STT</th>
                        <th>Nguồn cấp dữ liệu</th>
                        <th>Phương thức nhập</th>
                        <th>Trạng thái</th>
                        <th>Cập nhật</th>
                        <th>SP hiệu lực</th>
                        <th>SP lỗi dữ liệu</th>
                    </tr>
                </thead>
                <tbody id="dataSourcesTableBody">
                    <!-- Data will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="./js/script.js"></script>
    <script>
        const baseUrl = 'http://127.0.0.1:5000/api/v1';

        document.addEventListener('DOMContentLoaded', function() {
            requireAuth();
            fetchDataSources();
        });

        async function fetchDataSources() {
            try {
                const response = await fetchWithAuth(`${baseUrl}/data-sources`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error('Không thể tải dữ liệu nguồn cấp');
                }

                renderDataSources(data);
                updateFooter(data);
            } catch (error) {
                console.error('Error:', error);
                if (error.message === 'Unauthorized') {
                    window.location.href = '/frontend/login.html';
                } else {
                    Toast.error('Đã xảy ra lỗi khi tải dữ liệu');
                }
            }
        }

        function renderDataSources(dataSources) {
            const tbody = document.getElementById('dataSourcesTableBody');
            tbody.innerHTML = '';

            dataSources.forEach((source, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox"></td>
                    <td>${index + 1}</td>
                    <td>
                        <a href="#" class="link">${source.ten_nguon}</a>
                    </td>
                    <td>
                        <i class="fab fa-google"></i>
                        Google Sheet
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(source.active)}">
                            ${source.active ? 'Đang xử lý' : 'Không thể truy cập'}
                        </span>
                    </td>
                    <td>${formatDate(source.updated_at)}</td>
                    <td>${getValidProductsCount(source)}</td>
                    <td>${getErrorProductsCount(source)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getStatusClass(active) {
            return active ? 'status-active' : 'status-inactive';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getValidProductsCount(source) {
            // Đây là placeholder, bạn cần thêm logic đếm sản phẩm hợp lệ
            return 0;
        }

        function getErrorProductsCount(source) {
            // Đây là placeholder, bạn cần thêm logic đếm sản phẩm lỗi
            return 0;
        }

        function updateFooter(dataSources) {
            const footer = document.createElement('div');
            footer.className = 'table-footer';
            footer.innerHTML = `Số nguồn dữ liệu: <span style="font-weight: 500;">${dataSources.length}</span>`;
            document.querySelector('.table-container').appendChild(footer);
        }

        async function createDataSource() {
            // Implement logic to create new data source
            window.location.href = '/frontend/data-source-create.html';
        }

        function viewProducts() {
            window.location.href = '/frontend/products.html';
        }
    </script>
</body>

</html>