<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh sách chiến dịch - Ads Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./css/toast.css">
  <script src="./js/auth.js"></script>
  <script src="./js/toast.js"></script>
  <script src="./js/script.js"></script>
  <style>
    .campaign-table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
    }

    .frozen-column {
      position: sticky;
      left: 0;
      background: #F8F9FA;
      z-index: 1;
    }

    .frozen-column:last-of-type {
      border-right: 2px solid #E0E0E0;
    }

    .campaign-table tbody td:nth-child(-n+3) {
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }

    .campaign-table tbody td:nth-child(3) {
      border-right: 2px solid #E0E0E0;
    }

    .user-info {
      position: relative;
      cursor: pointer;
    }

    .user-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 150px;
    }

    .user-info:hover .user-dropdown {
      display: block;
    }

    .dropdown-item {
      padding: 12px 16px;
      color: #4F4F4F;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dropdown-item:hover {
      background: #F8F9FA;
    }

    .customize-column-dropdown {
      position: relative;
      display: inline-block;
    }

    .customize-column-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      cursor: pointer;
    }

    .customize-column-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 16px;
      z-index: 1000;
      width: 300px;
    }

    .customize-column-menu.show {
      display: block;
    }

    .customize-column-menu h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: #333;
    }

    .customize-column-section {
      margin-bottom: 16px;
    }

    .customize-column-section h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #4F4F4F;
    }

    .column-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .column-option label {
      font-size: 14px;
      color: #4F4F4F;
      cursor: pointer;
    }

    .customize-column-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #E0E0E0;
    }

    .btn-reset {
      padding: 8px 16px;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-apply {
      padding: 8px 16px;
      background: #0061C1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Toggle Menu Button -->
  <button class="menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">

      <span class="logo-text">Ads Manager</span>
    </div>

    <nav class="sidebar-nav">
      <a href="/frontend/campaigns.html" class="nav-item">
        <i class="fas fa-layer-group"></i>
        <span>Quản lý chiến dịch</span>
      </a>

      <div class="nav-group">
        <div class="nav-item" onclick="toggleSubmenu(this)">
          <i class="fas fa-box"></i>
          <span>Quản lý sản phẩm</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </div>
        <div class="submenu">
          <a href="/frontend/product-groups.html">• Danh sách nhóm SP</a>
          <a href="/frontend/products.html">• Danh sách SP</a>
          <a href="/frontend/data-sources.html">• Nguồn cấp dữ liệu</a>
        </div>
      </div>

      <a href="/frontend/target-audience.html" class="nav-item">
        <i class="fas fa-users"></i>
        <span>Quản lý đối tượng</span>
      </a>

      <a href="/frontend/publishers.html" class="nav-item">
        <i class="fas fa-users-cog"></i>
        <span>Danh sách Publisher</span>
      </a>

      <div class="nav-group">
        <div class="nav-item" onclick="toggleSubmenu(this)">
          <i class="fas fa-globe"></i>
          <span>Quản lý website</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </div>
        <div class="submenu">
          <a href="/frontend/price-lists.html">• Danh sách bảng giá</a>
          <a href="/frontend/websites.html">• Danh sách website</a>
          <a href="/frontend/ad-zones.html">• Danh sách vùng QC</a>
        </div>
      </div>

      <a href="/frontend/accounts.html" class="nav-item">
        <i class="fas fa-user-shield"></i>
        <span>Quản lý phân quyền</span>
      </a>
      <div class="nav-group">
        <div class="nav-item" onclick="toggleSubmenu(this)">
          <i class="fas fa-chart-bar"></i>
          <span>Báo cáo</span>
          <i class="fas fa-chevron-right dropdown-arrow"></i>
        </div>
        <div class="submenu">
          <a href="/frontend/website-report.html">• Báo cáo website</a>
          <a href="/frontend/zone-report.html">• Báo cáo vùng</a>
          <a href="/frontend/publisher-report.html" class="active">• Báo cáo publisher</a>
          <a href="/frontend/ad-format-report.html">• Báo cáo định dạng quảng cáo</a>
        </div>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header-content"
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 8px; color: #4F4F4F;">
        <i class="fas fa-layer-group"></i>
        <span style="font-size: 14px;">/ Quản lý chiến dịch</span>
      </div>
      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="user-name"></div>
          <div class="user-email" id="user-email"></div>
        </div>
        <i class="fas fa-user"></i>
        <div class="user-dropdown">
          <div class="dropdown-item" onclick="auth.logout()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </div>
        </div>
      </div>
    </div>

    <!-- Campaign List Section -->
    <div style="background: white; border-radius: 8px; padding: 24px;">
      <h1 style="margin: 0 0 24px 0; font-size: 20px; color: #333;">Danh sách chiến dịch</h1>

      <!-- Tabs -->
      <div class="tabs" style="display: flex; gap: 32px; margin-bottom: 24px; border-bottom: 1px solid #E0E0E0;">
        <div style="padding: 12px 0; color: #0061C1; border-bottom: 2px solid #0061C1; font-weight: 500;">
          <a href="/frontend/campaigns.html" style="color: #0061C1; text-decoration: none;">Chiến dịch</a>
        </div>
        <div style="padding: 12px 0; color: #4F4F4F;">
          <a href="/frontend/ads-group.html" style="color: #4F4F4F; text-decoration: none;">Nhóm quảng cáo</a>
        </div>
        <div style="padding: 12px 0; color: #4F4F4F;">
          <a href="/frontend/ads.html" style="color: #4F4F4F; text-decoration: none;">Tin quảng cáo</a>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <div class="action-left">
          <div class="filter-group">
            <select id="customerFilter" class="form-select" style="padding: 8px 12px; border: 1px solid #E0E0E0; border-radius: 4px; width: 200px;">
              <option value="">Chọn khách hàng</option>
            </select>
          </div>
          <button onclick="window.location.href='campaign-create.html'"
            style="background: #0061C1; color: white; border: none; border-radius: 4px; padding: 8px 16px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-plus"></i> Tạo chiến dịch
          </button>
          <div style="position: relative;">
            <i class="fas fa-search"
              style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #828282;"></i>
            <input type="text" placeholder="Tìm kiếm"
              style="padding: 8px 12px 8px 36px; border: 1px solid #E0E0E0; border-radius: 4px; width: 240px;">
          </div>
        </div>

        <div class="action-right">
          <div style="display: flex; gap: 16px;">
            <select id="adTypeFilter" style="padding: 8px 12px; border: 1px solid #E0E0E0; border-radius: 4px; width: 160px;">
              <option value="">Loại QC</option>
            </select>
            <select id="statusFilter" style="padding: 8px 12px; border: 1px solid #E0E0E0; border-radius: 4px; width: 160px;">
              <option value="">Trạng thái</option>
              <option value="Tất cả">Tất cả</option>
              <option value="Chưa chạy">Chưa chạy</option>
              <option value="Đang chạy">Đang chạy</option>
              <option value="Tạm dừng">Tạm dừng</option>
              <option value="Lỗi">Lỗi</option>
              <option value="Hoàn thành">Hoàn thành</option>
              <option value="Chưa hoàn thành">Chưa hoàn thành</option>
            </select>
            <div class="customize-column-dropdown">
              <button class="customize-column-btn">
                <i class="fas fa-columns"></i>
                Tùy chỉnh cột
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="customize-column-menu">
                <h3>Chọn chỉ số hiển thị</h3>

                <div class="customize-column-section">
                  <h4>Chỉ số chung</h4>
                  <div class="column-option">
                    <input type="checkbox" id="col-total-cost" checked>
                    <label for="col-total-cost">Tổng chi phí</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-views" checked>
                    <label for="col-views">Lượt xem</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-clicks" checked>
                    <label for="col-clicks">Lượt nhấn</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-ctr" checked>
                    <label for="col-ctr">CTR</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-cpc" checked>
                    <label for="col-cpc">CPC</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-cpm" checked>
                    <label for="col-cpm">CPM</label>
                  </div>
                </div>

                <div class="customize-column-section">
                  <h4>Video view</h4>
                  <div class="column-option">
                    <input type="checkbox" id="col-video-view-3s" checked>
                    <label for="col-video-view-3s">Video view 3s</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-video-25">
                    <label for="col-video-25">Video watches at 25%</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-video-50">
                    <label for="col-video-50">Video watches at 50%</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-video-75">
                    <label for="col-video-75">Video watches at 75%</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-video-100">
                    <label for="col-video-100">Video watches at 100%</label>
                  </div>
                </div>

                <div class="customize-column-section">
                  <h4>Ecommerce</h4>
                  <div class="column-option">
                    <input type="checkbox" id="col-purchases" checked>
                    <label for="col-purchases">SL mua hàng</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-conversion" checked>
                    <label for="col-conversion">% chuyển đổi mua hàng</label>
                  </div>
                  <div class="column-option">
                    <input type="checkbox" id="col-cps" checked>
                    <label for="col-cps">CPS</label>
                  </div>
                </div>

                <div class="customize-column-footer">
                  <button class="btn-reset" id="resetColumns">Đặt lại</button>
                  <button class="btn-apply" id="applyColumns">Hoàn tất</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table class="campaign-table">
          <thead>
            <tr style="background: #F8F9FA;">
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                <input type="checkbox" style="margin-right: 8px;">
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                STT
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Bật/tắt
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Tiêu đề
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Trạng thái
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: left; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Loại QC
              </th>
              <th class="total-cost-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Tổng chi phí (VNĐ)
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="views-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Lượt xem
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="clicks-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Lượt nhấn
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="ctr-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                CTR (%)
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="cpc-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                CPC (VNĐ)
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="cpm-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                CPM (VNĐ)
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="video-view-3s-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Video view 3s
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="video-25-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0; display: none;">
                Video watches at 25%
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="video-50-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0; display: none;">
                Video watches at 50%
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="video-75-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0; display: none;">
                Video watches at 75%
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="video-100-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0; display: none;">
                Video watches at 100%
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="purchases-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                SL mua hàng
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="conversion-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                % chuyển đổi mua hàng
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="cps-cell"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                CPS (VNĐ)
                <div style="font-weight: normal; font-size: 12px;">Ngày</div>
                <div style="font-weight: normal; font-size: 12px;">Tổng</div>
              </th>
              <th class="frozen-column"
                style="padding: 12px 16px; text-align: right; font-weight: 500; color: #4F4F4F; border-bottom: 1px solid #E0E0E0;">
                Bắt đầu/kết thúc
              </th>
            </tr>
          </thead>
          <tbody id="campaignTableBody"></tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="table-footer"
        style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-top: 1px solid #E0E0E0; margin-top: 16px; flex-wrap: wrap; gap: 16px;">
        <div style="color: #4F4F4F; font-size: 14px;">Số chiến dịch: <span id="total-campaigns"
            style="font-weight: 500;"></span></div>
        <div style="display: flex; gap: 24px; color: #4F4F4F;">
          <div>Tổng ngân sách: <span id="total-budget" style="font-weight: 500;"></span></div>
          <div>Tổng chi phí: <span id="total-cost" style="font-weight: 500;"></span></div>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/script.js"></script>

  <script>
    const baseUrl = 'http://127.0.0.1:5000/api/v1';


    function formatCurrency(value) {
      if (value === undefined || value === null || isNaN(value)) return '0';
      try {
        const number = parseFloat(value);
        return number.toLocaleString('vi-VN', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      } catch (error) {
        console.error('Error formatting currency:', error);
        return '0';
      }
    }

    function formatNumber(value) {
      if (value === undefined || value === null) return '-';
      return value.toLocaleString('vi-VN');
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN');
    }

    // Thêm biến để lưu trữ bộ lọc
    let filters = {
        search: '',
        adType: '',
        status: '',
        customer: ''
    };

    // Cập nhật hàm filterCampaigns
    function filterCampaigns(campaigns) {
        return campaigns.filter(campaign => {
            // Lọc theo từ khóa tìm kiếm (tên chiến dịch)
            const searchMatch = !filters.search || 
                (campaign.ten_chien_dich && campaign.ten_chien_dich.toLowerCase().includes(filters.search.toLowerCase()));

            // Lọc theo loại quảng cáo
            const typeMatch = !filters.adType || 
                campaign.ten_loai_quang_cao === filters.adType;

            // Lọc theo trạng thái
            const statusMatch = !filters.status || filters.status === 'Tất cả' || 
                campaign.ten_trang_thai === filters.status;

            // Lọc theo khách hàng
            const customerMatch = !filters.customer || 
                (campaign.ho_va_ten && campaign.ho_va_ten === filters.customer);

            return searchMatch && typeMatch && statusMatch && customerMatch;
        });
    }

    // Cập nhật hàm renderCampaigns để hiển thị dữ liệu chính xác
    function renderCampaigns(campaigns) {
        const tbody = document.getElementById('campaignTableBody');
        tbody.innerHTML = '';

        if (!campaigns || campaigns.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="18" style="text-align: center; padding: 20px;">
                        Không tìm thấy chiến dịch nào
                    </td>
                </tr>
            `;
            // Reset các số liệu tổng khi không có dữ liệu
            document.getElementById('total-campaigns').textContent = '0';
            document.getElementById('total-budget').textContent = formatCurrency(0);
            document.getElementById('total-cost').textContent = formatCurrency(0);
            return;
        }

        // Tính toán tổng cho các chiến dịch đã được lọc
        const totalBudget = campaigns.reduce((sum, camp) => sum + (parseFloat(camp.ngan_sach_ngay) || 0), 0);
        const totalCost = campaigns.reduce((sum, camp) => sum + (parseFloat(camp.tong_chi_phi) || 0), 0);

        // Cập nhật UI với số liệu tổng mới
        document.getElementById('total-campaigns').textContent = campaigns.length;
        document.getElementById('total-budget').textContent = formatCurrency(totalBudget);
        document.getElementById('total-cost').textContent = formatCurrency(totalCost);

        // Render các chiến dịch
        campaigns.forEach((campaign, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    <input type="checkbox">
                </td>
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    ${index + 1}
                </td>
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    <label class="switch">
                        <input type="checkbox" 
                               ${campaign.active ? 'checked' : ''} 
                               onchange="toggleCampaignStatus(${campaign.camp_id}, this.checked)">
                        <span class="slider round"></span>
                    </label>
                </td>
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    <a href="#" style="color: #2F80ED; text-decoration: none;">
                        ${campaign.ten_chien_dich || '-'}
                    </a>
                </td>
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    ${campaign.ten_trang_thai || '-'}
                </td>
                <td style="padding: 12px 16px; text-align: left; border-bottom: 1px solid #E0E0E0;">
                    ${campaign.ten_loai_quang_cao || '-'}
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatCurrency(campaign.ngan_sach_ngay)}</div>
                    <div>${formatCurrency(campaign.tong_chi_phi)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.luot_xem)}</div>
                    <div>${formatNumber(campaign.luot_xem)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.luot_nhan)}</div>
                    <div>${formatNumber(campaign.luot_nhan)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.ctr)}%</div>
                    <div>${formatNumber(campaign.ctr)}%</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatCurrency(campaign.cpc)}</div>
                    <div>${formatCurrency(campaign.cpc)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatCurrency(campaign.cpm)}</div>
                    <div>${formatCurrency(campaign.cpm)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.videoview3s)}</div>
                    <div>${formatNumber(campaign.videoview3s)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.so_luong_mua_hang)}</div>
                    <div>${formatNumber(campaign.so_luong_mua_hang)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatNumber(campaign.conversion_rate)}%</div>
                    <div>${formatNumber(campaign.conversion_rate)}%</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    <div>${formatCurrency(campaign.cps)}</div>
                    <div>${formatCurrency(campaign.cps)}</div>
                </td>
                <td style="padding: 12px 16px; text-align: right; border-bottom: 1px solid #E0E0E0;">
                    ${campaign.ngay_bat_dau} - ${campaign.ngay_ket_thuc}
                </td>

            `;
            tbody.appendChild(tr);
        });
    }

    // Cập nhật hàm setupEventListeners để xử lý các sự kiện lọc
    function setupEventListeners() {
        // Lọc theo khách hàng
        const customerSelect = document.getElementById('customerFilter');
        if (customerSelect) {
            customerSelect.addEventListener('change', function(e) {
                filters.customer = this.value;
                applyFilters();
            });
        }

        // Lọc theo từ khóa
        const searchInput = document.querySelector('input[type="text"][placeholder="Tìm kiếm"]');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                filters.search = e.target.value;
                applyFilters();
            });
        }

        // Lọc theo loại quảng cáo
        const adTypeSelect = document.getElementById('adTypeFilter');
        if (adTypeSelect) {
            adTypeSelect.addEventListener('change', function(e) {
                filters.adType = this.value;
                applyFilters();
            });
        }

        // Lọc theo trạng thái
        const statusSelect = document.querySelector('select[id="statusFilter"]');
        if (statusSelect) {
            statusSelect.addEventListener('change', function(e) {
                filters.status = this.value;
                applyFilters();
            });
        }
    }

    // Cập nhật hàm fetchCampaigns để log dữ liệu nhận được
    async function fetchCampaigns() {
        try {
            console.log('Fetching campaigns...');
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                window.location.href = '/frontend/login.html';
                return;
            }

            const response = await fetch(`${baseUrl}/campaigns`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (!response.ok) {
                throw new Error(data.error || 'Không thể tải dữ liệu chiến dịch');
            }

            if (!data.campaigns || !Array.isArray(data.campaigns)) {
                throw new Error('Dữ liệu không đúng định dạng');
            }

            // Lưu dữ liệu gốc và log để debug
            originalCampaigns = data.campaigns;
            console.log('Loaded campaigns:', originalCampaigns);
            
            // Render với bộ lọc hiện tại
            applyFilters();

        } catch (error) {
            console.error('Error fetching campaigns:', error);
            handleFetchError(error);
        }
    }

    // Hàm áp dụng bộ lọc
    function applyFilters() {
        const filteredCampaigns = filterCampaigns(originalCampaigns);
        renderCampaigns(filteredCampaigns);
    }

    // Hàm xử lý lỗi
    function handleFetchError(error) {
        if (error.message === 'Unauthorized') {
            window.location.href = '/frontend/login.html';
        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            Toast.error('Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng.');
        } else {
            Toast.error(`Đã xảy ra lỗi: ${error.message}`);
        }

        // Set giá trị mặc định cho UI khi có lỗi
        document.getElementById('total-budget').textContent = formatCurrency(0);
        document.getElementById('total-cost').textContent = formatCurrency(0);
        document.getElementById('total-campaigns').textContent = '0';
        document.getElementById('campaignTableBody').innerHTML = `
            <tr>
                <td colspan="18" style="text-align: center; padding: 20px;">
                    Không thể tải dữ liệu. Vui lòng thử lại sau.
                </td>
            </tr>
        `;
    }

    // Thêm hàm để lấy danh sách loại chiến dịch
    async function fetchCampaignTypes() {
        try {
            const response = await fetchWithAuth(`${baseUrl}/campaign-types`);
            const data = await response.json();
            
            if (data && data.campaign_types) {
                const adTypeSelect = document.querySelector('select[id="adTypeFilter"]');
                // Xóa options cũ trừ option đầu tiên
                adTypeSelect.innerHTML = '<option value="">Loại QC</option>';
                
                // Thêm các options mới
                data.campaign_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.ten_loai_chien_dich;
                    option.textContent = type.ten_loai_chien_dich;
                    adTypeSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching campaign types:', error);
            Toast.error('Không thể tải danh sách loại chiến dịch');
        }
    }

    // Thêm hàm để lấy danh sách khách hàng
    async function fetchCustomers() {
        try {
            console.log('Fetching customers...');
            const token = localStorage.getItem('token');
            const response = await fetch(`${baseUrl}/customers`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            console.log('Customers data:', data);

            if (data && data.customers) {
                const customerSelect = document.getElementById('customerFilter');
                // Reset select
                customerSelect.innerHTML = '<option value="">Tất cả khách hàng</option>';
                
                // Thêm options mới
                data.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.ho_va_ten;
                    option.textContent = customer.ho_va_ten;
                    customerSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching customers:', error);
            Toast.error('Không thể tải danh sách khách hàng');
        }
    }

    // Thêm hàm để kiểm tra token
    function checkAuthentication() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('No token found, redirecting to login');
            window.location.href = '/frontend/login.html';
            return false;
        }
        return true;
    }

    // Thêm các hàm xử lý tùy chỉnh cột
    function setupColumnCustomization() {
        const customizeBtn = document.querySelector('.customize-column-btn');
        const customizeMenu = document.querySelector('.customize-column-menu');
        const applyBtn = document.getElementById('applyColumns');
        const resetBtn = document.getElementById('resetColumns');

        // Toggle menu khi click vào nút tùy chỉnh
        customizeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            customizeMenu.classList.toggle('show');
        });

        // Đóng menu khi click ra ngoài
        document.addEventListener('click', function(e) {
            if (!customizeMenu.contains(e.target) && !customizeBtn.contains(e.target)) {
                customizeMenu.classList.remove('show');
            }
        });

        // Xử lý khi click nút Apply
        applyBtn.addEventListener('click', function() {
            const columns = {
                'total-cost': document.getElementById('col-total-cost').checked,
                'views': document.getElementById('col-views').checked,
                'clicks': document.getElementById('col-clicks').checked,
                'ctr': document.getElementById('col-ctr').checked,
                'cpc': document.getElementById('col-cpc').checked,
                'cpm': document.getElementById('col-cpm').checked,
                'video-view-3s': document.getElementById('col-video-view-3s').checked,
                'video-25': document.getElementById('col-video-25').checked,
                'video-50': document.getElementById('col-video-50').checked,
                'video-75': document.getElementById('col-video-75').checked,
                'video-100': document.getElementById('col-video-100').checked,
                'purchases': document.getElementById('col-purchases').checked,
                'conversion': document.getElementById('col-conversion').checked,
                'cps': document.getElementById('col-cps').checked
            };

            // Lưu trạng thái cột vào localStorage
            localStorage.setItem('columnSettings', JSON.stringify(columns));

            // Áp dụng trạng thái hiển thị cho các cột
            Object.entries(columns).forEach(([columnName, isVisible]) => {
                const cells = document.querySelectorAll(`.${columnName}-cell`);
                cells.forEach(cell => {
                    cell.style.display = isVisible ? '' : 'none';
                });
            });

            customizeMenu.classList.remove('show');
            Toast.success('Đã cập nhật cài đặt hiển thị');
        });

        // Xử lý khi click nút Reset
        resetBtn.addEventListener('click', function() {
            // Reset tất cả checkbox về trạng thái mặc định
            document.querySelectorAll('.column-option input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });

            // Hiển thị lại tất cả các cột
            document.querySelectorAll('[class$="-cell"]').forEach(cell => {
                cell.style.display = '';
            });

            // Xóa cài đặt đã lưu
            localStorage.removeItem('columnSettings');
            
            Toast.success('Đã khôi phục cài đặt mặc định');
        });

        // Load trạng thái cột đã lưu
        const savedColumns = localStorage.getItem('columnSettings');
        if (savedColumns) {
            const columns = JSON.parse(savedColumns);
            Object.entries(columns).forEach(([columnName, isVisible]) => {
                // Set checkbox state
                const checkbox = document.getElementById(`col-${columnName}`);
                if (checkbox) {
                    checkbox.checked = isVisible;
                }
                // Set column visibility
                const cells = document.querySelectorAll(`.${columnName}-cell`);
                cells.forEach(cell => {
                    cell.style.display = isVisible ? '' : 'none';
                });
            });
        }
    }

    // Cập nhật event listener khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, checking authentication...');
        if (checkAuthentication()) {
            console.log('Authentication successful, fetching data...');
            fetchCampaigns();
            fetchCustomers();
            setupEventListeners();
            setupColumnCustomization(); // Thêm setup cho tùy chỉnh cột
        }
    });
  </script>
</body>

</html>