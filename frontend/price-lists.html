<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách bảng giá - Ads Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./css/toast.css">
    <script src="./js/auth.js"></script>
        <script src="./js/toast.js"></script>
    <script src="./js/script.js"></script>
    <script src="./js/script.js"></script>

    <style>
        .tabs {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
            border-bottom: 1px solid #E0E0E0;
        }

        .tab {
            padding: 8px 0;
            color: #4F4F4F;
            cursor: pointer;
            position: relative;
            font-weight: 500;
        }

        .tab.active {
            color: #0061C1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #0061C1;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            align-items: center;
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-primary {
            background: #0061C1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .dropdown {
            padding: 8px 12px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            min-width: 300px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .table th {
            background: #F8F9FA;
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: #333;
            border-bottom: 1px solid #E0E0E0;
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid #E0E0E0;
        }

        .publisher-email {
            color: #666;
            font-size: 13px;
        }

        .status.running {
            background: #E3F2FD;
            color: #2F80ED;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .price-type {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sell-price {
            color: #27AE60;
        }

        .buy-price {
            color: #EB5757;
        }

        .sub-row {
            background: #F8F9FA;
        }

        .start-date {
            color: #666;
            font-size: 13px;
        }

        .edit-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            float: right;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #4F4F4F;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E0E0E0;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #0061C1;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .zone-size {
            color: #666;
            font-size: 13px;
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .price-info .sell-price {
            color: #28a745;
        }

        .price-info .buy-price {
            color: #dc3545;
        }

        .zone-size {
            color: #666;
            font-size: 13px;
        }

        .btn-secondary {
            background: #FFFFFF;
            color: #333333;
            border: 1px solid #E0E0E0;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #F8F9FA;
        }

        .column-customize {
            position: relative;
        }

        .column-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 16px;
            width: 320px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            margin-top: 8px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .column-group {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .column-group h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 16px;
            color: #333;
            padding: 0 4px;
        }

        #formatGroups {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin: 0 -4px;
            max-height: calc(80vh - 120px);
            /* Custom scrollbar styles */
            scrollbar-width: thin;
            scrollbar-color: #E0E0E0 transparent;
        }

        #formatGroups::-webkit-scrollbar {
            width: 6px;
        }

        #formatGroups::-webkit-scrollbar-track {
            background: transparent;
        }

        #formatGroups::-webkit-scrollbar-thumb {
            background-color: #E0E0E0;
            border-radius: 3px;
        }

        .format-group {
            margin: 0 4px 12px 4px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            background: white;
        }

        .format-group:last-child {
            margin-bottom: 0;
        }

        .format-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F8F9FA;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            user-select: none;
        }

        .format-group-header label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            user-select: none;
            color: #333;
        }

        .format-group-header .count {
            color: #666;
            font-size: 13px;
            margin-left: 4px;
        }

        .format-list {
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid #E0E0E0;
            background: white;
            max-height: none !important;
            overflow: visible !important;
        }

        .format-list label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            color: #4F4F4F;
            padding: 4px 0;
        }

        .format-list label:hover {
            color: #0061C1;
        }

        .dropdown-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E0E0E0;
            background: white;
        }

        /* Checkbox styles */
        .format-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border: 1.5px solid #E0E0E0;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            appearance: none;
            background: white;
            flex-shrink: 0;
        }

        .format-group input[type="checkbox"]:checked {
            background-color: #0061C1;
            border-color: #0061C1;
        }

        .format-group input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Expand/collapse animation */
        .format-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .format-group.expanded .format-list {
            max-height: 500px;
        }

        .format-group-header i {
            transition: transform 0.2s ease;
            color: #666;
            font-size: 12px;
        }

        .format-group.expanded .format-group-header i {
            transform: rotate(180deg);
        }

        /* Add styles for table scrolling */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 24px;
            /* Custom scrollbar styles */
            scrollbar-width: thin;
            scrollbar-color: #E0E0E0 transparent;
        }

        .table-container::-webkit-scrollbar {
            height: 6px;
        }

        .table-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: #E0E0E0;
            border-radius: 3px;
        }

        .table {
            min-width: 1200px; /* Minimum width to ensure scrolling */
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            display: inline-block;
        }

        .status.running {
            background: #E3F2FD;
            color: #2F80ED;
        }

        .status.pending {
            background: #FFF3E0;
            color: #F2994A;
        }

        .status.paused {
            background: #FFEBEE;
            color: #EB5757;
        }

        .sub-row {
            background: #F8F9FA;
        }

        .sub-row .start-date {
            color: #666;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-row .start-date i {
            color: #999;
            font-size: 12px;
        }

        .zone-size {
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }

        .price-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .price-info .sell-price {
            color: #27AE60;
        }

        .price-info .buy-price {
            color: #EB5757;
        }
    </style>
</head>

<body>
    <!-- Toggle Menu Button -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            
            <span class="logo-text">Ads Manager</span>
        </div>

        <nav class="sidebar-nav">
            <a href="/frontend/campaigns.html" class="nav-item">
                <i class="fas fa-layer-group"></i>
                <span>Quản lý chiến dịch</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-box"></i>
                    <span>Quản lý sản phẩm</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/product-groups.html">• Danh sách nhóm SP</a>
                    <a href="/frontend/products.html">• Danh sách SP</a>
                    <a href="/frontend/data-sources.html">• Nguồn cấp dữ liệu</a>
                </div>
            </div>

            <a href="/frontend/target-audience.html" class="nav-item">
                <i class="fas fa-users"></i>
                <span>Quản lý đối tượng</span>
            </a>



            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-chart-bar"></i>
                    <span>Báo cáo</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/website-report.html">• Báo cáo website</a>
                    <a href="/frontend/zone-report.html">• Báo cáo vùng</a>
                    <a href="/frontend/publisher-report.html" class="active">• Báo cáo publisher</a>
                    <a href="/frontend/ad-format-report.html">• Báo cáo định dạng quảng cáo</a>
                </div>
            </div>

            <a href="/frontend/publishers.html" class="nav-item">
                <i class="fas fa-users-cog"></i>
                <span>Danh sách Publisher</span>
            </a>

            <div class="nav-group">
                <div class="nav-item" onclick="toggleSubmenu(this)">
                    <i class="fas fa-globe"></i>
                    <span>Quản lý website</span>
                    <i class="fas fa-chevron-right dropdown-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="/frontend/price-lists.html">• Danh sách bảng giá</a>
                    <a href="/frontend/websites.html">• Danh sách website</a>
                    <a href="/frontend/ad-zones.html">• Danh sách vùng QC</a>
                </div>
            </div>
            <a href="/frontend/accounts.html" class="nav-item">
                <i class="fas fa-user-shield"></i>
                <span>Quản lý phân quyền</span>
            </a>
        </nav>
    </div>

    <div class="main-content">
        <!-- Header -->
        <div class="header-content">
            <div class="breadcrumb">
                <i class="fas fa-globe"></i>
                <span>/ Quản lý website / Danh sách bảng giá</span>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="user-name"></div>
                    <div class="user-email" id="user-email"></div>
                </div>
                <i class="fas fa-user"></i>
<div class="user-dropdown">
                    <div class="dropdown-item" onclick="auth.logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Đăng xuất
                    </div>
                </div>
                
            </div>
        </div>

        <h1 class="page-title">Danh sách bảng giá website</h1>
        <button class="btn-primary" onclick="createPricing()" style="margin-bottom: 24px;">
            <i class="fas fa-plus"></i>
            Tạo bảng giá
        </button>

        <div class="tabs">
            <div class="tab active" data-view="website">Website</div>
            <div class="tab" data-view="adzone">Vùng quảng cáo</div>
        </div>

        <div class="action-bar">
            <div class="controls">
                <select class="dropdown" id="websiteSelect" style="display: none;">
                    <option value="" disabled selected>Chọn website</option>
                </select>
                
                <!-- Add column customization dropdown -->
                <div class="column-customize">
                    <button class="btn-secondary" onclick="toggleColumnCustomize()">
                        <i class="fas fa-columns"></i>
                        Tùy chỉnh cột
                    </button>
                    <div class="column-dropdown" id="columnDropdown" style="display: none;">
                        <div class="column-group">
                            <h3>Chọn bảng giá hiển thị</h3>
                            <div id="formatGroups">
                                <!-- Format groups will be populated dynamically -->
                            </div>
                        </div>
                        <div class="dropdown-footer">
                            <button class="btn-secondary" onclick="resetColumns()">Đặt lại</button>
                            <button class="btn-primary" onclick="applyColumns()">Áp dụng</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="websiteView">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Website</th>
                            <th>Loại QC</th>
                            <th>Trạng thái giá</th>
                            <th>Loại giá</th>
                            <th>CatFish Ecom (VND)</th>
                            <th>Mobile Banner Card (VND)</th>
                            <th>Interactive Banner (VND)</th>
                            <th>Flying Carpet (VND)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                Kinhdoanh.tuoitre.vn<br>
                                <span class="publisher-email">publisher@gmail.com</span>
                            </td>
                            <td>
                                <div>Ecommerce</div>
                                <div>Display ads</div>
                            </td>
                            <td><span class="status running">Đang chạy</span></td>
                            <td>
                                <div class="price-type">
                                    <span class="sell-price">Giá bán</span>
                                    <span class="buy-price">Giá mua</span>
                                </div>
                            </td>
                            <td>
                                <div>CPC 2.000</div>
                                <div>CPC 50.000</div>
                            </td>
                            <td>
                                <div>CPC 2.000</div>
                                <div>CPC 50.000</div>
                            </td>
                            <td>
                                <div>CPC 2.000</div>
                                <div>CPC 2.000</div>
                            </td>
                            <td>
                                <div>CPC 2.000</div>
                                <div>CPC 2.000</div>
                            </td>
                        </tr>
                        <tr class="sub-row">
                            <td colspan="3">
                                <div class="start-date">Ngày bắt đầu 28/03/2022 15:00</div>
                            </td>
                            <td colspan="5">
                                <button class="edit-btn"><i class="fas fa-pen"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="adzoneView" style="display: none;">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Stt</th>
                            <th style="width: 80px;">Bật/tắt</th>
                            <th style="width: 200px;">Vùng quảng cáo</th>
                            <th style="width: 120px;">Trạng thái giá</th>
                            <th style="width: 100px;">Loại giá</th>
                            <!-- Dynamic format columns will be added here -->
                            <th style="width: 120px;">Ngày kết thúc</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="./js/script.js"></script>

    <script>
        const baseUrl = 'http://127.0.0.1:5000/api/v1';
        document.addEventListener('DOMContentLoaded', function() {
            requireAuth();
            loadPriceLists();
        });

        let selectedColumns = {};
        let allFormats = {};
        let currentPrices = {}; // Store current prices as object
        let pricesByWebsite = {}; // Store grouped prices

        function formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        async function loadPriceLists() {
            try {
                const viewType = document.querySelector('.tab.active').dataset.view;
                const websiteId = document.querySelector('#websiteSelect').value;
                
                const response = await fetchWithAuth(
                    `${baseUrl}/prices?view_type=${viewType}${websiteId ? `&website_id=${websiteId}` : ''}`
                );
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Không thể tải dữ liệu bảng giá');
                }

                // Store formats and prices globally
                allFormats = data.data.formats;
                currentPrices = data.data.prices; // Now an object with website_prices structure

                // Initialize column selection if needed
                if (Object.keys(selectedColumns).length === 0) {
                    initializeColumnSelection(allFormats);
                }

                // Update column customization dropdown
                updateColumnCustomizationDropdown(allFormats);

                if (viewType === 'website') {
                    renderGlobalPrices(currentPrices);
                } else {
                    renderZonePrices(currentPrices, allFormats);
                }

            } catch (error) {
                console.error('Error:', error);
                Toast.error('Không thể tải dữ liệu bảng giá', 'Lỗi');
            }
        }

        function initializeColumnSelection(formats) {
            selectedColumns = {};
            Object.entries(formats).forEach(([type, formatList]) => {
                selectedColumns[type] = formatList.map(f => ({
                    id: f.format_id,
                    name: f.format_name,
                    selected: true
                }));
            });
        }

        function updateColumnCustomizationDropdown(formats) {
            const container = document.getElementById('formatGroups');
            container.innerHTML = '';
            const viewType = document.querySelector('.tab.active').dataset.view;
            const selectedColumnsObj = viewType === 'website' ? selectedColumns : zoneSelectedColumns;

            Object.entries(formats).forEach(([type, formatList]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'format-group expanded';
                
                const header = document.createElement('div');
                header.className = 'format-group-header';
                
                const groupCheckbox = document.createElement('input');
                groupCheckbox.type = 'checkbox';
                groupCheckbox.checked = viewType === 'website' ? 
                    isGroupFullySelected(type) : 
                    isZoneGroupFullySelected(type);
                groupCheckbox.onchange = (e) => {
                    e.stopPropagation();
                    if (viewType === 'website') {
                        toggleGroup(type);
                    } else {
                        toggleZoneGroup(type);
                    }
                };
                
                const groupLabel = document.createElement('label');
                groupLabel.appendChild(groupCheckbox);
                
                const groupName = document.createElement('span');
                groupName.textContent = type;
                groupLabel.appendChild(groupName);
                
                const countSpan = document.createElement('span');
                countSpan.className = 'count';
                countSpan.textContent = `(${viewType === 'website' ? 
                    getSelectedCount(type) : 
                    getZoneSelectedCount(type)}/${formatList.length})`;
                groupLabel.appendChild(countSpan);
                
                header.appendChild(groupLabel);
                
                const formatsList = document.createElement('div');
                formatsList.className = 'format-list';
                
                formatList.forEach(format => {
                    const formatLabel = document.createElement('label');
                    const formatCheckbox = document.createElement('input');
                    formatCheckbox.type = 'checkbox';
                    formatCheckbox.value = format.format_id;
                    formatCheckbox.checked = viewType === 'website' ? 
                        isFormatSelected(type, format.format_id) : 
                        isZoneFormatSelected(type, format.format_id);
                    formatCheckbox.onchange = (e) => {
                        e.stopPropagation();
                        if (viewType === 'website') {
                            toggleFormat(type, format.format_id);
                        } else {
                            toggleZoneFormat(type, format.format_id);
                        }
                    };
                    
                    formatLabel.appendChild(formatCheckbox);
                    formatLabel.appendChild(document.createTextNode(format.format_name));
                    formatsList.appendChild(formatLabel);
                });

                groupDiv.appendChild(header);
                groupDiv.appendChild(formatsList);
                container.appendChild(groupDiv);
            });
        }

        function renderGlobalPrices(prices) {
            const tbody = document.querySelector('#websiteView tbody');
            tbody.innerHTML = '';

            // Iterate through website prices
            Object.entries(prices).forEach(([websiteId, websiteData]) => {
                const { website_info, prices: websitePrices } = websiteData;
                
                websitePrices.forEach(price => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${website_info.domain_website}<br>
                            <span class="publisher-email">${website_info.publisher_email}</span>
                        </td>
                        <td>${price.campaign_type_name}</td>
                        <td>
                            <span class="status ${price.active ? 'running' : 'stopped'}">
                                ${price.active ? 'Đang chạy' : 'Đã dừng'}
                            </span>
                        </td>
                        <td>
                            <div class="price-type">
                                <span class="sell-price">Giá bán</span>
                                <span class="buy-price">Giá mua</span>
                            </div>
                        </td>
                        <td>
                            <div>${price.is_uniform_price ? formatPrice(price.uniform_sell_price) : formatPrice(price.sell_price)}</div>
                            <div>${price.is_uniform_price ? formatPrice(price.uniform_buy_price) : formatPrice(price.buy_price)}</div>
                        </td>
                    `;
                    tbody.appendChild(row);

                    // Add sub-row with start date and edit button
                    const subRow = document.createElement('tr');
                    subRow.className = 'sub-row';
                    subRow.innerHTML = `
                        <td colspan="3">
                            <div class="start-date">
                                <i class="far fa-calendar-alt"></i>
                                Ngày bắt đầu ${formatDate(price.start_date)}
                            </div>
                        </td>
                        <td colspan="2">
                            <button onclick="editPriceList('${price.global_price_id}')" class="edit-btn">
                                <i class="fas fa-pen"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(subRow);
                });
            });
        }

        function toggleGroup(type) {
            const isChecked = !isGroupFullySelected(type);
            selectedColumns[type].forEach(format => {
                format.selected = isChecked;
            });
            updateColumnCustomizationDropdown(allFormats);
            updateTableColumns();
        }

        function toggleFormat(type, formatId) {
            const format = selectedColumns[type].find(f => f.id === formatId);
            if (format) {
                format.selected = !format.selected;
                updateColumnCustomizationDropdown(allFormats);
                updateTableColumns();
            }
        }

        function isGroupFullySelected(type) {
            return selectedColumns[type]?.every(format => format.selected) ?? false;
        }

        function getSelectedCount(type) {
            return selectedColumns[type]?.filter(format => format.selected).length ?? 0;
        }

        function isFormatSelected(type, formatId) {
            return selectedColumns[type]?.find(f => f.id === formatId)?.selected ?? false;
        }

        function getVisibleColumnsCount() {
            let count = 0;
            Object.entries(selectedColumns).forEach(([type, formats]) => {
                count += formats.filter(f => f.selected).length;
            });
            return count;
        }

        function resetColumns() {
            const viewType = document.querySelector('.tab.active').dataset.view;
            if (viewType === 'website') {
                initializeColumnSelection(allFormats);
                updateColumnCustomizationDropdown(allFormats);
                renderGlobalPrices(currentPrices, allFormats);
            } else {
                initializeZoneColumnSelection(zoneAllFormats);
                updateColumnCustomizationDropdown(zoneAllFormats);
                renderZonePrices(currentZonePrices, zoneAllFormats);
            }
        }

        function applyColumns() {
            document.getElementById('columnDropdown').style.display = 'none';
            const viewType = document.querySelector('.tab.active').dataset.view;
            if (viewType === 'website') {
                renderGlobalPrices(currentPrices, allFormats);
            } else {
                renderZonePrices(currentZonePrices, zoneAllFormats);
            }
        }

        function toggleColumnCustomize() {
            const dropdown = document.getElementById('columnDropdown');
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                // Close dropdown when clicking outside
                document.addEventListener('click', closeDropdownOutside);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOutside);
            }
        }

        function closeDropdownOutside(event) {
            const dropdown = document.getElementById('columnDropdown');
            const customizeButton = document.querySelector('.column-customize button');
            
            if (!dropdown.contains(event.target) && !customizeButton.contains(event.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdownOutside);
            }
        }

        function toggleGroupExpand(groupDiv) {
            groupDiv.classList.toggle('expanded');
        }

        function editPriceList(websiteId) {
            window.location.href = `price-list-create.html?website_id=${websiteId}`;
        }

        // Update website filter handler
        document.getElementById('websiteSelect').addEventListener('change', async function() {
            try {
                const websiteId = this.value;
                if (!websiteId) return;

                const response = await fetchWithAuth(`${baseUrl}/prices?website_id=${websiteId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error('Không thể tải dữ liệu bảng giá');
                }

                // Re-render price list with filtered data
                const websiteView = document.getElementById('websiteView');
                const tbody = websiteView.querySelector('tbody');
                tbody.innerHTML = '';

                // ... (same rendering logic as in loadPriceLists)
            } catch (error) {
                console.error('Error:', error);
                Toast.error('Không thể tải dữ liệu bảng giá', 'Lỗi');
            }
        });

        function createPricing() {
            window.location.href = '/frontend/price-list-create.html';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const websiteTab = document.querySelector('[data-view="website"]');
            const adzoneTab = document.querySelector('[data-view="adzone"]');
            const websiteView = document.getElementById('websiteView');
            const adzoneView = document.getElementById('adzoneView');
            const websiteSelect = document.getElementById('websiteSelect');

            // Load all formats first
            loadAllFormats();

            websiteTab.addEventListener('click', () => {
                websiteTab.classList.add('active');
                adzoneTab.classList.remove('active');
                websiteView.style.display = 'block';
                adzoneView.style.display = 'none';
                websiteSelect.style.display = 'block'; // Show website select for website view
                loadPriceLists();
            });

            adzoneTab.addEventListener('click', () => {
                adzoneTab.classList.add('active');
                websiteTab.classList.remove('active');
                adzoneView.style.display = 'block';
                websiteView.style.display = 'none';
                websiteSelect.style.display = 'none'; // Hide website select for adzone view
                loadZonePrices();
            });

            // Initial load and set visibility
            if (adzoneTab.classList.contains('active')) {
                websiteSelect.style.display = 'none';
                loadZonePrices();
            } else {
                websiteSelect.style.display = 'block';
                loadPriceLists();
            }
        });

        function updateTableColumns() {
            // Update table headers
            updateTableHeaders(allFormats);
            
            // Update table rows
            const tbody = document.querySelector('#websiteView tbody');
            const rows = tbody.querySelectorAll('tr:not(.sub-row)');
            
            rows.forEach(row => {
                // Skip website header rows
                if (row.classList.contains('website-header')) {
                    // Update colspan for header rows
                    const headerCell = row.querySelector('td');
                    if (headerCell) {
                        headerCell.colSpan = 4 + getVisibleColumnsCount();
                    }
                    return;
                }

                // Get the base cells (first 4 columns)
                const baseCells = Array.from(row.querySelectorAll('td')).slice(0, 4);
                
                // Clear existing row content
                row.innerHTML = '';
                
                // Add back the base cells
                baseCells.forEach(cell => row.appendChild(cell));
                
                // Add price columns based on selected formats
                Object.entries(allFormats).forEach(([type, formatList]) => {
                    formatList.forEach(format => {
                        if (isFormatSelected(type, format.format_id)) {
                            const priceCell = document.createElement('td');
                            const formatPrice = findPriceForFormat(row, format.format_id);
                            priceCell.innerHTML = `
                                <div class="price-info">
                                    <div class="sell-price">
                                        ${formatPrice ? `${formatPrice.sell_price_type_name} ${formatPrice.sell_price.toLocaleString('vi-VN')}` : '-'}
                                    </div>
                                    <div class="buy-price">
                                        ${formatPrice ? `${formatPrice.buy_price_type_name} ${formatPrice.buy_price.toLocaleString('vi-VN')}` : '-'}
                                    </div>
                                </div>
                            `;
                            row.appendChild(priceCell);
                        }
                    });
                });
            });

            // Update sub-rows
            const subRows = tbody.querySelectorAll('tr.sub-row');
            subRows.forEach(subRow => {
                const dateTd = subRow.querySelector('td:first-child');
                const buttonTd = subRow.querySelector('td:last-child');
                subRow.innerHTML = '';
                if (dateTd) subRow.appendChild(dateTd);
                if (buttonTd) {
                    buttonTd.colSpan = getVisibleColumnsCount() + 1;
                    subRow.appendChild(buttonTd);
                }
            });
        }

        function findPriceForFormat(row, formatId) {
            // Get website ID from the row
            const websiteId = row.dataset.websiteId;
            if (!websiteId) return null;

            // Find price data for this website and format
            const websiteData = pricesByWebsite[websiteId];
            if (!websiteData) return null;

            return websiteData.prices.find(p => p.format_id === formatId);
        }

        let zoneSelectedColumns = {};
        let zoneAllFormats = {};
        let currentZonePrices = [];
        let pricesByZone = {};

        async function loadZonePrices() {
            try {
                const websiteId = document.querySelector('#websiteSelect').value;
                const url = `${baseUrl}/prices?view_type=adzone${websiteId ? `&website_id=${websiteId}` : ''}`;
                
                const response = await fetchWithAuth(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error('Failed to load zone prices');
                }

                // Store formats and prices globally
                currentZonePrices = data.prices;
                
                // Group prices by zone
                pricesByZone = {};
                if (data.prices && data.prices.zone_prices) {
                    Object.entries(data.prices.zone_prices).forEach(([zoneId, zoneData]) => {
                        pricesByZone[zoneId] = zoneData;
                    });
                }
                        
                // Render zone prices using all formats
                renderZonePrices(currentZonePrices, zoneAllFormats);
            } catch (error) {
                console.error('Error:', error);
                Toast.error('Không thể tải dữ liệu bảng giá vùng', 'Lỗi');
            }
        }

        function initializeZoneColumnSelection(formats) {
            zoneSelectedColumns = {};
            Object.entries(formats).forEach(([type, formatList]) => {
                zoneSelectedColumns[type] = formatList.map(f => ({
                    id: f.format_id,
                    name: f.format_name,
                    selected: true
                }));
            });
        }

        function updateZoneColumnCustomizationDropdown(formats) {
            const container = document.getElementById('formatGroups');
            container.innerHTML = '';

            Object.entries(formats).forEach(([type, formatList]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'format-group expanded';
                
                const header = document.createElement('div');
                header.className = 'format-group-header';
                
                const groupCheckbox = document.createElement('input');
                groupCheckbox.type = 'checkbox';
                groupCheckbox.checked = isZoneGroupFullySelected(type);
                groupCheckbox.onchange = (e) => {
                    e.stopPropagation();
                    toggleZoneGroup(type);
                };
                
                const groupLabel = document.createElement('label');
                groupLabel.appendChild(groupCheckbox);
                
                const groupName = document.createElement('span');
                groupName.textContent = type;
                groupLabel.appendChild(groupName);
                
                const countSpan = document.createElement('span');
                countSpan.className = 'count';
                countSpan.textContent = `(${getZoneSelectedCount(type)}/${formatList.length})`;
                groupLabel.appendChild(countSpan);
                
                header.appendChild(groupLabel);
                
                const formatsList = document.createElement('div');
                formatsList.className = 'format-list';
                
                formatList.forEach(format => {
                    const formatLabel = document.createElement('label');
                    const formatCheckbox = document.createElement('input');
                    formatCheckbox.type = 'checkbox';
                    formatCheckbox.value = format.format_id;
                    formatCheckbox.checked = isZoneFormatSelected(type, format.format_id);
                    formatCheckbox.onchange = (e) => {
                        e.stopPropagation();
                        toggleZoneFormat(type, format.format_id);
                    };
                    
                    formatLabel.appendChild(formatCheckbox);
                    formatLabel.appendChild(document.createTextNode(format.format_name));
                    formatsList.appendChild(formatLabel);
                });

                groupDiv.appendChild(header);
                groupDiv.appendChild(formatsList);
                container.appendChild(groupDiv);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('vi-VN');
        }

        function renderZonePrices(prices, formats) {
            const tbody = document.querySelector('#adzoneView tbody');
            tbody.innerHTML = '';

            let index = 1;
            if (!prices) return;

            Object.entries(prices).forEach(([zoneId, zoneData]) => {
                const { zone_info = {}, prices = [] } = zoneData;
                
                // Create main row
                const mainRow = document.createElement('tr');
                mainRow.dataset.zoneId = zoneId;
                mainRow.innerHTML = `
                    <td>${index}</td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${zone_info?.active ? 'checked' : ''} 
                                   onchange="toggleZoneStatus(${zoneId}, this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column;">
                            <span>${zone_info?.ten_vung_quang_cao || '-'}</span>
                            <span class="zone-size">${zone_info?.size_name || '-'}</span>
                        </div>
                    </td>
                    <td>
                        <span class="status ${getStatusClass(prices[0]?.status)}">
                            ${getStatusText(prices[0]?.status)}
                        </span>
                    </td>
                    <td>
                        <div class="price-type">
                            <span class="sell-price">Giá bán</span>
                            <span class="buy-price">Giá mua</span>
                        </div>
                    </td>
                `;

                // Add price columns based on selected formats
                Object.entries(formats).forEach(([type, formatList]) => {
                    formatList.forEach(format => {
                        if (isZoneFormatSelected(type, format.format_id)) {
                            const formatPrice = prices.find(p => p.format_id === format.format_id);
                            mainRow.innerHTML += `
                                <td>
                                    <div class="price-info">
                                        <div class="sell-price">
                                            ${formatPrice ? `${formatPrice.sell_price_type_name || '-'} ${formatPrice.sell_price?.toLocaleString('vi-VN') || '-'}` : '-'}
                                        </div>
                                        <div class="buy-price">
                                            ${formatPrice ? `${formatPrice.buy_price_type_name || '-'} ${formatPrice.buy_price?.toLocaleString('vi-VN') || '-'}` : '-'}
                                        </div>
                                    </div>
                                </td>
                            `;
                        }
                    });
                });

                // Add end date column
                mainRow.innerHTML += `
                    <td>${formatDate(prices[0]?.end_date)}</td>
                `;

                tbody.appendChild(mainRow);

                // Add history rows if available
                if (prices.length > 1) {
                    prices.slice(1).forEach(price => {
                        const historyRow = document.createElement('tr');
                        historyRow.className = 'sub-row';
                        historyRow.innerHTML = `
                            <td colspan="4">
                                <div class="start-date">
                                    <i class="fas fa-history"></i>
                                    Ngày bắt đầu ${formatDate(price.start_date)}
                                </div>
                            </td>
                            <td colspan="${getZoneVisibleColumnsCount() + 2}">
                                <button class="edit-btn" onclick="editZonePriceList(${zoneId}, ${price.zone_price_setup_id})">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(historyRow);
                    });
                }

                index++;
            });

            // Update table headers
            updateZoneTableHeaders();
        }

        function updateZoneTableHeaders() {
            const thead = document.querySelector('#adzoneView thead tr');
            thead.innerHTML = `
                <th style="width: 50px;">Stt</th>
                <th style="width: 80px;">Bật/tắt</th>
                <th style="width: 200px;">Vùng quảng cáo</th>
                <th style="width: 120px;">Trạng thái giá</th>
                <th style="width: 100px;">Loại giá</th>
            `;

            // Add headers for selected format columns
            Object.entries(zoneAllFormats).forEach(([type, formatList]) => {
                formatList.forEach(format => {
                    if (isZoneFormatSelected(type, format.format_id)) {
                        thead.innerHTML += `<th>${format.format_name} (VND)</th>`;
                    }
                });
            });

            thead.innerHTML += `<th style="width: 120px;">Ngày kết thúc</th>`;
        }

        function toggleZoneGroup(type) {
            const isChecked = !isZoneGroupFullySelected(type);
            zoneSelectedColumns[type].forEach(format => {
                format.selected = isChecked;
            });
            updateColumnCustomizationDropdown(zoneAllFormats);
            renderZonePrices(currentZonePrices, zoneAllFormats);
        }

        function toggleZoneFormat(type, formatId) {
            const format = zoneSelectedColumns[type].find(f => f.id === formatId);
            if (format) {
                format.selected = !format.selected;
                updateColumnCustomizationDropdown(zoneAllFormats);
                renderZonePrices(currentZonePrices, zoneAllFormats);
            }
        }

        function isZoneGroupFullySelected(type) {
            return zoneSelectedColumns[type]?.every(format => format.selected) ?? false;
        }

        function getZoneSelectedCount(type) {
            return zoneSelectedColumns[type]?.filter(format => format.selected).length ?? 0;
        }

        function isZoneFormatSelected(type, formatId) {
            return zoneSelectedColumns[type]?.find(f => f.id === formatId)?.selected ?? false;
        }

        function getZoneVisibleColumnsCount() {
            let count = 0;
            Object.entries(zoneSelectedColumns).forEach(([type, formats]) => {
                count += formats.filter(f => f.selected).length;
            });
            return count;
        }

        function resetZoneColumns() {
            initializeZoneColumnSelection(zoneAllFormats);
            updateColumnCustomizationDropdown(zoneAllFormats);
            renderZonePrices(currentZonePrices, zoneAllFormats);
        }

        function applyZoneColumns() {
            document.getElementById('columnDropdown').style.display = 'none';
            renderZonePrices(currentZonePrices, zoneAllFormats);
        }

        function getStatusClass(status) {
            switch (status) {
                case 'running': return 'running';
                case 'pending': return 'pending';
                case 'paused': return 'paused';
                default: return 'running';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'running': return 'Đang chạy';
                case 'pending': return 'Chưa chạy';
                case 'paused': return 'Tạm dừng';
                default: return 'Đang chạy';
            }
        }

        function toggleZoneStatus(zoneId, status) {
            // Implement zone status toggle logic here
            console.log(`Toggle zone ${zoneId} to ${status}`);
        }

        async function loadAllFormats() {
            try {
                const response = await fetchWithAuth(`${baseUrl}/prices/formats`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error('Failed to load formats');
                }

                // Store all formats
                zoneAllFormats = data.data.formats_by_type;
                
                // Initialize column selection if not already set
                if (Object.keys(zoneSelectedColumns).length === 0) {
                    initializeZoneColumnSelection(zoneAllFormats);
                }

                // Update column customization dropdown
                updateColumnCustomizationDropdown(zoneAllFormats);
            } catch (error) {
                console.error('Error:', error);
                Toast.error('Không thể tải danh sách định dạng quảng cáo', 'Lỗi');
            }
        }
    </script>
</body>

</html>